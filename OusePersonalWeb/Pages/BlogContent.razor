@page "/blogContent"
@using Blazored.LocalStorage
@using MudBlazor.Services
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ILocalStorageService localStorage
@inject IBrowserViewportService BrowserViewportService
@implements IAsyncDisposable
@if (string.IsNullOrEmpty(fullUrl))
{
    <div style="width:100%;height:100vh" class="d-flex flex-column justify-center align-center">
        <div class="load_6"></div> @* 你之前的加载动画 *@
    </div>
}
else
{
    <div class="d-flex gap-4">
        <MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
            <MudMarkdown Value="@fullUrl"
                         TableOfContentsHeader="目录"
                         HasTableOfContents="@(_currentBrowserWindowSize.Width>600?true:false)"
                         Props="mudMarkdownProps"
                         SourceType="MarkdownSourceType.Url"
                         Styling="@mudMarkdownStyling" />
        </MudContainer>

    </div>
}
<style>
    .mud-markdown-toc-drawer {
        position: fixed;
        right: 0;
    }

    .mud-markdown-toc-nav-menu {
        height: 90vh;
        overflow: auto;
    }
</style>

@code {
    [SupplyParameterFromQuery(Name = "url")]
    public string BlogUrl { get; set; } = string.Empty;
    private readonly Guid _observerId = Guid.NewGuid();
    private BrowserWindowSize _currentBrowserWindowSize = new();
    private string? fullUrl;
    private MudMarkdownStyling mudMarkdownStyling = new();
    private MudMarkdownProps mudMarkdownProps = new();
    private CodeBlockTheme CodeBlock { get; set; } = CodeBlockTheme.A11yDark;

    protected override async Task OnInitializedAsync()
    {
        // 加载配置
        CodeBlock = await localStorage.GetItemAsync<CodeBlockTheme>(Settings.CodeBlockTheme);
        mudMarkdownStyling.CodeBlock.Theme = CodeBlock;
        mudMarkdownStyling.CodeBlock.CopyButton = CodeBlockCopyButton.Sticky;
        mudMarkdownStyling.CodeBlock.CopyButtonText = "复制";

        mudMarkdownProps.Heading.OverrideTypo = typo => typo switch
        {
            Typo.h1 => Typo.h4, // # 映射为 h4
            Typo.h2 => Typo.h5, // ## 映射为 h5
            Typo.h3 => Typo.h6, // ### 映射为 h6
            _ => typo           // 其他保持不变
        };

        // 配置图片路径重写
        mudMarkdownProps.Link.OverrideUrl = (link) =>
        {
            // 检查这是否是一个图片链接
            if (link.IsImage)
            {
                var originalUrl = link.Url;

                // 如果已经是绝对路径（http开头的），直接返回
                if (string.IsNullOrEmpty(originalUrl) || originalUrl.StartsWith("http"))
                    return originalUrl;

                // 核心逻辑：获取当前 md 文件所在的文件夹路径
                // 例如 BlogUrl 是 "Dotnet/dotnet.md"，那么目录就是 "Dotnet/"
                var lastSlashIndex = BlogUrl.LastIndexOf('/');
                var folderPath = lastSlashIndex > -1 ? BlogUrl.Substring(0, lastSlashIndex + 1) : "";

                // 拼接成完整的 GitHub Raw 路径
                // Settings.BlogRawRoot 结尾已有 /，folderPath 结尾已有 /
                // 最终结果如: https://raw.githubusercontent.com/.../main/Dotnet/assets/1.png
                Console.WriteLine(originalUrl);
                return $"{Settings.BlogRawRoot}{folderPath}{originalUrl}";
            }

            return link.Url; // 普通超链接保持不变
        };

        if (string.IsNullOrEmpty(BlogUrl))
        {
            Navigation.NavigateTo("/ouseblog");
            return;
        }

        // 拼接 main 分支的原始文件地址
        fullUrl = $"{Settings.BlogRawRoot}{BlogUrl}";
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await BrowserViewportService.SubscribeAsync(_observerId, async args =>
            {
                _currentBrowserWindowSize = args.BrowserWindowSize;
                await InvokeAsync(StateHasChanged);
            });
        }
    }

    public async ValueTask DisposeAsync()
    {
        await BrowserViewportService.DisposeAsync();
        await BrowserViewportService.DisposeAsync();
    }

    private async Task SaveTheme()
    {
        mudMarkdownStyling.CodeBlock.Theme = CodeBlock;
        await localStorage.SetItemAsync(Settings.CodeBlockTheme, CodeBlock);
    }
}