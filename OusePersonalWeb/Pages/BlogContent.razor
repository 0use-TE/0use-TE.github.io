@page "/blogContent/{*BlogUrl}"
@using Blazored.LocalStorage
@using MudBlazor.Services
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject ILocalStorageService localStorage
@if (string.IsNullOrEmpty(fullUrl))
{
    <div style="width:100%;height:100vh" class="d-flex flex-column justify-center align-center">
        <div class="load_6"></div> @* 你之前的加载动画 *@
    </div>
}
else
{
    <div class="d-flex gap-4">

        <MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
            <MudHidden Hidden Breakpoint="Breakpoint.SmAndDown">
                <MudMarkdown Value="@fullUrl"
                             TableOfContentsHeader="目录"
                             HasTableOfContents
                             Props="mudMarkdownProps"
                             SourceType="MarkdownSourceType.Url"
                             Styling="@mudMarkdownStyling" />
            </MudHidden>
            <MudHidden Hidden Breakpoint="Breakpoint.MdAndUp">
                <MudMarkdown Value="@fullUrl"
                             TableOfContentsHeader="目录"
                             HasTableOfContents="false"
                             Props="mudMarkdownProps"
                             SourceType="MarkdownSourceType.Url"
                             Styling="@mudMarkdownStyling" />
            </MudHidden>
        </MudContainer>
    </div>
}
<style>
    .mud-markdown-toc-drawer {
        position: fixed;
        right: 0;
    }

    .mud-markdown-toc-nav-menu {
        height: 90vh;
        overflow: auto;
    }
</style>

@code {
    [Parameter]
    public string BlogUrl { get; set; } = string.Empty;
    private readonly Guid _observerId = Guid.NewGuid();
    private BrowserWindowSize _currentBrowserWindowSize = new();
    private string? fullUrl;
    private MudMarkdownStyling mudMarkdownStyling = new();
    private MudMarkdownProps mudMarkdownProps = new();
    private CodeBlockTheme CodeBlock { get; set; } = CodeBlockTheme.A11yDark;

    protected override async Task OnInitializedAsync()
    {
        // 加载配置
        CodeBlock = await localStorage.GetItemAsync<CodeBlockTheme>(Settings.CodeBlockTheme);
        mudMarkdownStyling.CodeBlock.Theme = CodeBlock;
        mudMarkdownStyling.CodeBlock.CopyButton = CodeBlockCopyButton.Sticky;
        mudMarkdownStyling.CodeBlock.CopyButtonText = "复制";
        mudMarkdownStyling.Table.IsBordered = true;
        mudMarkdownProps.Heading.OverrideTypo = typo => typo switch
        {
            Typo.h1 => Typo.h4, // # 映射为 h4
            Typo.h2 => Typo.h5, // ## 映射为 h5
            Typo.h3 => Typo.h6, // ### 映射为 h6
            _ => typo           // 其他保持不变
        };

        mudMarkdownProps.Link.OverrideUrl = (link) =>
        {
            if (string.IsNullOrEmpty(link.Url)) return link.Url;

            if (link.IsImage)
            {
                var originalUrl = link.Url;

                // 如果是绝对路径，直接返回
                if (originalUrl.StartsWith("http")) return originalUrl;

                // --- 核心修复逻辑 ---
                // 1. 统一去掉开头的 "./" 或 "/"，让路径变成相对纯净的状态
                // 例如 "./assets/1.jpg" -> "assets/1.jpg"
                // 例如 "assets/1.jpg"   -> "assets/1.jpg"
                var cleanUrl = originalUrl.TrimStart('.', '/');

                // 2. 获取当前文件所在的目录
                var lastSlashIndex = BlogUrl.LastIndexOf('/');
                var folderPath = lastSlashIndex > -1 ? BlogUrl.Substring(0, lastSlashIndex + 1) : "";

                // 3. 拼接：确保 Settings.BlogRawRoot 结尾有 /，folderPath 结尾也有 /
                // 最终格式：[Root]/[Folder/][assets/1.jpg]
                var root = Settings.BlogRawRoot.EndsWith("/") ? Settings.BlogRawRoot : Settings.BlogRawRoot + "/";
                var finalUrl = $"{root}{folderPath}{cleanUrl}";

                return finalUrl;
            }

            return link.Url;
        };

        if (string.IsNullOrEmpty(BlogUrl))
        {
            Navigation.NavigateTo("/ouseblog");
            return;
        }

        // 拼接 main 分支的原始文件地址
        fullUrl = $"{Settings.BlogRawRoot}{BlogUrl}";
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
    }


    private async Task SaveTheme()
    {
        mudMarkdownStyling.CodeBlock.Theme = CodeBlock;
        await localStorage.SetItemAsync(Settings.CodeBlockTheme, CodeBlock);
    }
}