@page "/ouseblog"
@using System.Web
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6 d-flex flex-column"  Style="height:100%">
    <MudTextField Variant="Variant.Outlined" @bind-Value="searchContent"
                  Placeholder="搜索博客标题或分类..." Class="py-4 flex-grow-0"
                  AdornmentIcon="@Icons.Material.Rounded.Search"
                  InputType="InputType.Search"
                  OnKeyUp="Filter"
                  Adornment="Adornment.Start" T="string" Immediate="true"></MudTextField>

    <div class="gap-4 overflow-y-scroll flex-grow-1">
        @if (filteredPosts == null)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else
        {
            @foreach (var post in filteredPosts)
            {
                <MudButton OnClick="@(() => OpenPost(post.path))" Class="hvr-underline-reveal" FullWidth>
                    <MudPaper Class="rounded-lg pa-4" Outlined="true" Width="100%" >
                        <div class="d-flex justify-space-between align-center">
                            <MudText Typo="Typo.h6">@post.title</MudText>
                            <MudChip Color="Color.Warning" Size="Size.Small" T="string" Variant="Variant.Text">@post.category</MudChip>
                        </div>
                    </MudPaper>
                </MudButton>
            }
        }
    </div>
</MudContainer>

@code {
    private string searchContent = string.Empty;
    private List<BlogPost>? allPosts;
    private List<BlogPost>? filteredPosts;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient();
            allPosts = await client.GetFromJsonAsync<List<BlogPost>>(Settings.BlogIndexUrl);

            // 从 URL 读取搜索参数（支持返回时恢复）
            var uri = new Uri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var q = query["q"];
            if (!string.IsNullOrEmpty(q))
            {
                searchContent = q;
                Filter();
            }
            else
            {
                filteredPosts = allPosts;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("获取索引失败: " + ex.Message, Severity.Error);
        }
    }

    private void Filter()
    {
        if (string.IsNullOrWhiteSpace(searchContent))
            filteredPosts = allPosts;
        else
            filteredPosts = allPosts?.Where(x => x.title.Contains(searchContent, StringComparison.OrdinalIgnoreCase)
            ||x.category.Contains(searchContent,StringComparison.OrdinalIgnoreCase)).ToList();
    }

    private async Task OpenPost(string path)
    {
        // 先修改 URL 保存搜索状态，再跳转
        var url = $"/ouseblog?q={Uri.EscapeDataString(searchContent)}";
        await JSRuntime.InvokeVoidAsync("window.history.pushState", null, "", url);
        Navigation.NavigateTo($"/blogContent/{path}");
    }

    public class BlogPost {
        public string title { get; set; } = "";
        public string path { get; set; } = "";
        public string category { get; set; } = "";
        public string date { get; set; } = "";
    }
}