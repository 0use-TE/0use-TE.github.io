@page "/"
@page "/home"
@using OusePersonalWeb.Components
@using static OusePersonalWeb.Pages.Blog
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IHttpClientFactory HttpClientFactory
<PageTitle>主页</PageTitle>
<MudContainer MaxWidth="MaxWidth.False" Class="d-flex flex-column align-center  ">
    <div class="d-flex justify-center ">
        <MudText Class="slogan" Align="Align.Center"><MudText Inline Class="slogan" Color="Color.Primary">0</MudText>use</MudText>
        <MudText Class="slogan slogan-sec slogan-ext" Align="Align.Center" Color="Color.Primary">Blog</MudText>
    </div>
    <MudText Class="slogan2 mt-n4" Align="Align.Center">从0到use</MudText>

    <div class="d-flex flex-column align-center ">
        <div class="pa-4 d-flex gap-4 ">
            <Animate Animation="Animations.FadeRight" DurationMs="500">
                <MudTooltip Text="QQ账号">
                    <SvgButton Type="SvgType.QQ" Href="tencent://message/?uin=2216528769Site=MyWebsite&Menu=yes"></SvgButton>
                </MudTooltip>
            </Animate>

            <Animate Animation="Animations.FadeDown" DurationMs="500">
                <MudTooltip Text="GitHub账号">
                    <SvgButton Type="SvgType.Github" Href="https://github.com/0use-TE"></SvgButton>
                </MudTooltip>

            </Animate>

            <Animate Animation="Animations.FadeLeft" DurationMs="500">
                <MudTooltip Text="微软账号">
                    <SvgButton Type="SvgType.Microsoft" Href=""></SvgButton>
                </MudTooltip>
            </Animate>
        </div>
        <MudText Typo="Typo.subtitle2">联系方式</MudText>
    </div>
    <MudDivider Style="width: 24vw" />
    <br />
    <br />

    <Width xs="10" sm="8">
        <div class="d-flex" style="width: 100%;">
            <div style="position: relative; flex: 1;">
                <MudTextField @bind-Value="searchText"
                              Label="查找您想找的..."
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Rounded.Search"
                              Placeholder="输入文章标题或分类..."
                              DebounceInterval="100"
                              OnDebounceIntervalElapsed="PerformSearch"
                              OnKeyDown="OnSearchKeyDown" />
                @if (showResults && filteredPosts?.Count > 0)
                {
                    <MudPaper Class="search-results" Elevation="4">
                        <MudList T="BlogPost">
                            @foreach (var post in filteredPosts)
                            {
                                <MudListItem OnClick="@(() => SelectPost(post))"
                                             Style="@(post == selectedPost ? "background-color: var(--mud-palette-primary-hover);" : "")">
                                    <MudText>@post.title</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    </MudPaper>
                }
                @if (showResults && filteredPosts?.Count == 0 && !string.IsNullOrWhiteSpace(searchText))
                {
                    <MudPaper Class="search-results" Elevation="4">
                        <MudText Class="pa-2" Color="Color.Error">未找到匹配结果</MudText>
                    </MudPaper>
                }
            </div>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="OpenPost" Class="ml-2">前往</MudButton>
        </div>
    </Width>


    <Width xs="10" sm="8" Class="pt-4">
        <MudGrid>
            <!-- 博客卡片 -->
            <MudItem xs="12" sm="4" Class="d-flex">
                <Animate Animation="Animations.FadeIn" DurationMs="2000">
                    <MudCard Elevation="4" Class="card" @onclick="@(() => LoadToPage("ouseblog"))" Style="height:100%">
                        <MudCardHeader>
                            <MudText Typo="Typo.h6">博客</MudText>
                            <MudIcon Class="ml-auto" Icon="@Icons.Material.Rounded.Article"></MudIcon> <!-- 博客图标 -->
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText>
                                <strong>博客</strong>：在我的博客中，我会分享关于编程的各类文章以及生活中的点点滴滴，包括技术技巧、开发心得等。
                                通过这些文章，希望能为您带来帮助,带来快乐!
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </Animate>
            </MudItem>

            <!-- 开源卡片 -->
            <MudItem xs="12" sm="4" Class="d-flex">
                <Animate Animation="Animations.FadeIn" DurationMs="2000">
                    <MudCard Elevation="4" Class="card" @onclick="@(() => LoadToPage("opensource"))" Style="height:100%">
                        <MudCardHeader>
                            <MudText Typo="Typo.h6">开源</MudText>
                            <MudIcon Class="ml-auto" Icon="@Icons.Material.Rounded.Public"></MudIcon> <!-- 开源图标 -->
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText>
                                <strong>开源</strong>：我热衷于开源社区的建设.大学一年多来，我做了好多有趣的"小玩意"，包括游戏，软件...
                                如果对您有用，不妨Star一下，您的支持是我最大的动力！
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </Animate>
            </MudItem>

            <!-- 简历卡片 -->
            <MudItem xs="12" sm="4" Class="d-flex">
                <Animate Animation="Animations.FadeIn" DurationMs="2000">
                    <MudCard Elevation="4" Class="card" @onclick="@(() => LoadToPage("resume"))" Style="height:100%">
                        <MudCardHeader>
                            <MudText Typo="Typo.h6">简历</MudText>
                            <MudIcon Class="ml-auto" Icon="@Icons.Material.Rounded.PersonPin"></MudIcon> <!-- 简历图标 -->
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText>
                                <strong>简历</strong>：随着不断学习，这里我也会不断更新我的简历。您在这里可以看到我的学习路线，如果你对我的技术栈感兴趣，欢迎查看详细的简历内容。
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </Animate>
            </MudItem>
        </MudGrid>
    </Width>
</MudContainer>
@code {
    private List<BlogPost> allPosts = new();
    private BlogPost? selectedPost;
    private List<BlogPost>? filteredPosts;
    private string searchText = "";
    private bool showResults = false;

    private void PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            filteredPosts = allPosts.Take(5).ToList();
            showResults = false;
            return;
        }

        filteredPosts = allPosts
            .Where(p => p.title.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                     || (p.category != null && p.category.Contains(searchText, StringComparison.OrdinalIgnoreCase)))
            .Take(5)
            .ToList();
        selectedPost = filteredPosts.FirstOrDefault();
        showResults = true;
    }

    private void SelectPost(BlogPost post)
    {
        selectedPost = post;
        searchText = post.title;
        showResults = false;
        OpenPost();
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs args)
    {
        if (filteredPosts == null || filteredPosts.Count == 0)
            return;

        if (args.Key == "ArrowDown")
        {
            var currentIndex = selectedPost != null ? filteredPosts.IndexOf(selectedPost) : -1;
            if (currentIndex < filteredPosts.Count - 1)
            {
                selectedPost = filteredPosts[currentIndex + 1];
            }
        }
        else if (args.Key == "ArrowUp")
        {
            var currentIndex = selectedPost != null ? filteredPosts.IndexOf(selectedPost) : 0;
            if (currentIndex > 0)
            {
                selectedPost = filteredPosts[currentIndex - 1];
            }
        }
        else if (args.Key == "Enter" && selectedPost != null)
        {
            searchText = selectedPost.title;
            showResults = false;
            OpenPost();
        }
    }

    private Task<IEnumerable<BlogPost>> SearchPosts(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult<IEnumerable<BlogPost>>(allPosts);

        var filtered = allPosts
            .Where(p => p.title.Contains(value, StringComparison.OrdinalIgnoreCase)
                     || (p.category != null && p.category.Contains(value, StringComparison.OrdinalIgnoreCase)))
            .ToList();

        return Task.FromResult<IEnumerable<BlogPost>>(filtered);
    }
    private void OpenPost()
    {
        if (string.IsNullOrWhiteSpace(selectedPost?.path))
            return;
        Navigation.NavigateTo($"/blogContent/{selectedPost.path}");
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient();
            allPosts = await client.GetFromJsonAsync<List<BlogPost>>(Settings.BlogIndexUrl) ?? new List<BlogPost>();
            filteredPosts = allPosts;
        }
        catch (Exception ex)
        {
            Snackbar.Add("获取索引失败: " + ex.Message, Severity.Error);
        }
    }


    private void LoadToPage(string url) => Navigation.NavigateTo($"/{url}");
}

<style>
    .card:hover {
        box-shadow: 0 0 15px 5px rgba(0, 255, 255, 0.8), /* 青色荧光 */
        0 0 25px 10px rgba(0, 255, 255, 0.4); /* 更淡的外围光晕 */
        filter: brightness(1.1); /* 增加亮度，增强荧光感 */
        cursor: pointer;
    }

    .slogan {
        color: rebeccapurple;
        font-size: calc(20px + 4vw);
        font-weight: 900;
        font-family: "Roboto";
        letter-spacing: 0;
        transition: all 1s;
        user-select: none;
    }

        .slogan:hover {
            letter-spacing: calc(4px + 2vw);
        }

            .slogan:hover.slogan-ext:after {
                content: "land";
                color: var(--mud-palette-text-primary);
                letter-spacing: 0;
            }

    .slogan2 {
        color: deeppink;
        font-size: calc(12px + 1vw);
        font-weight: 900;
        font-family: "Roboto";
        letter-spacing: -0.1vw;
        transition: all 1s;
        user-select: none;
    }

        .slogan2:hover {
            letter-spacing: calc(2px + 1vw);
        }

    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
    }

</style>